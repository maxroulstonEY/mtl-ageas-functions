name: 'deployFunctions'

parameters:
- name: environment
  displayName: environment
  default: dev
  values: ["tst", "dev", "prd"]

trigger: none
pr: none

# pool: vmss-deploy-app-tst
pool: HISL Management

jobs:
- job: BuildAndDeploy
  steps:

  - task: PowerShell@2
    inputs:
      workingDirectory: MTL
      targetType: 'inline'
      script: |
        Compress-Archive -Path * -DestinationPath $(Build.ArtifactStagingDirectory)/my-azure-function.zip
      pwsh: true

  - task: AzureCLI@2
    inputs:
      workingDirectory: MTL
      azureSubscription: mtl-${{ parameters.environment }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az functionapp deployment source config-zip -g "rg-mtl-${{ parameters.environment }}" -n "fun-mtl-${{ parameters.environment }}-uks" --src $(Build.ArtifactStagingDirectory)/my-azure-function.zip
      addSpnToEnvironment: true
